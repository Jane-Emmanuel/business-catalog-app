<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Catalog</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#111111" />
  <link rel="icon" href="./icons/icon-192.png" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header { text-align: center; padding: 15px; background: #111; color: #fff; }
    #banner { width: 100%; max-height: 200px; object-fit: cover; }
    #logo { width: 80px; height: 80px; border-radius: 50%; margin-top: -40px; border: 3px solid #fff; }
    #business-name { font-size: 22px; font-weight: bold; margin: 10px 0; }
    #shop-description { font-size: 14px; color: #ddd; margin-bottom: 20px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:15px; padding:15px; }
    .card { background:#fff; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
    .price { font-size:18px; font-weight:bold; color:#333; }
    .discount { color:green; font-size:14px; }
    .editor-box { padding:15px; background:#fff; margin:15px; border-radius:10px; }
    input, select, button { padding:8px; margin:5px 0; width:100%; }
    button { background:#111; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    button.delete { background:red; }
  </style>
</head>
<body>
  <header>
    <img id="banner" src="" alt="Banner"/>
    <img id="logo" src="" alt="Logo"/>
    <div id="business-name" contenteditable="false">My Business</div>
    <div id="shop-description" contenteditable="false">Best products at the best prices</div>
  </header>

  <!-- Currency Selector -->
  <div style="text-align:center; margin:10px;">
    <label for="currencySelect">Currency:</label>
    <select id="currencySelect" onchange="updateCurrency()">
      <option value="$">$</option>
      <option value="₦">₦</option>
      <option value="€">€</option>
      <option value="£">£</option>
      <option value="₹">₹</option>
    </select>
  </div>

  <!-- WhatsApp -->
  <div style="text-align:center; margin:10px;">
    <input type="text" id="whatsappInput" placeholder="Enter WhatsApp Number" />
    <button onclick="saveWhatsApp()">Save WhatsApp</button>
  </div>

  <!-- Hidden Seller Login -->
  <div id="sellerLogin" style="display:none; text-align:center; margin:10px;">
    <input type="password" id="sellerPassword" placeholder="Seller Login Password" />
    <button onclick="checkLogin()">Login</button>
  </div>

  <!-- Seller Editor -->
  <div id="editorPanel" class="editor-box" style="display:none;">
    <h3>Seller Editor</h3>
    <input type="text" id="product-name" placeholder="Product Name" required>
    <input type="text" id="product-price" placeholder="Price" required>
    <input type="text" id="product-discount" placeholder="Discount (optional)">
    <input type="file" id="newImgFile" accept="image/*" onchange="previewUpload(event)">
    <img id="uploadPreview" style="max-width:100%;margin-top:10px;display:none;"/>
    <button onclick="addProduct()">Add Product</button>
    <h4>Upload Banner</h4>
    <input type="file" id="banner-upload" accept="image/*">
    <h4>Upload Logo</h4>
    <input type="file" id="logo-upload" accept="image/*">
  </div>

  <!-- Product List -->
  <div id="product-list" class="grid"></div>

  <script>
    let whatsappNumber = localStorage.getItem("whatsappNumber") || "2348012345678";
    let currentCurrency = localStorage.getItem("currency") || "$";
    let loggedIn = false;

    let defaultProducts = [
      {name: "Red Shoes", price: 40, discount: "20% off", img: "https://i.ibb.co/0VW7F32P/freepik-edit-Candid-image-photog-1.png"},
      {name: "Blue Dress", price: 55, discount: "10% off", img: "https://i.ibb.co/1f2Yxd6C/Leonardo-Phoenix-A-lovely-longsl.png"},
      {name: "Handbag", price: 30, discount: "", img: "https://i.ibb.co/zVTStV9n/freepik-edit-Candid-image-photog-1.png"}
    ];

    window.onload = () => {
      const savedBanner = localStorage.getItem("banner");
      const savedLogo = localStorage.getItem("logo");
      const savedName = localStorage.getItem("businessName");
      const savedDesc = localStorage.getItem("shopDesc");
      const savedProducts = JSON.parse(localStorage.getItem("products") || "null");

      if (savedBanner) document.getElementById("banner").src = savedBanner;
      if (savedLogo) document.getElementById("logo").src = savedLogo;
      if (savedName) document.getElementById("business-name").innerText = savedName;
      if (savedDesc) document.getElementById("shop-description").innerText = savedDesc;
      if (whatsappNumber) document.getElementById("whatsappInput").value = whatsappNumber;

      renderProducts(savedProducts || defaultProducts);
      document.getElementById("currencySelect").value = currentCurrency;

      // Only show login if seller opens it manually
      if (window.location.hash === "#seller") {
        document.getElementById("sellerLogin").style.display = "block";
      }
    };

    function saveWhatsApp() {
      const num = document.getElementById("whatsappInput").value.trim();
      if(num) {
        whatsappNumber = num;
        localStorage.setItem("whatsappNumber", num);
        alert("WhatsApp number saved!");
      }
    }

    function updateCurrency() {
      currentCurrency = document.getElementById("currencySelect").value;
      localStorage.setItem("currency", currentCurrency);
      const products = JSON.parse(localStorage.getItem("products") || "[]") || defaultProducts;
      renderProducts(products);
    }

    function checkLogin() {
      const pass = document.getElementById("sellerPassword").value;
      if (pass === "1234") {
        loggedIn = true;
        document.getElementById("editorPanel").style.display = "block";
        document.getElementById("business-name").setAttribute("contenteditable", "true");
        document.getElementById("shop-description").setAttribute("contenteditable", "true");
        alert("Seller editor unlocked!");
      } else {
        alert("Wrong password!");
      }
    }

    document.getElementById("business-name").addEventListener("input", (e) => {
      if (loggedIn) localStorage.setItem("businessName", e.target.innerText);
    });

    document.getElementById("shop-description").addEventListener("input", (e) => {
      if (loggedIn) localStorage.setItem("shopDesc", e.target.innerText);
    });

    document.getElementById("banner-upload").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
          document.getElementById("banner").src = evt.target.result;
          localStorage.setItem("banner", evt.target.result);
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById("logo-upload").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
          document.getElementById("logo").src = evt.target.result;
          localStorage.setItem("logo", evt.target.result);
        };
        reader.readAsDataURL(file);
      }
    });

    let uploadedImage = "";
    function previewUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          uploadedImage = e.target.result;
          document.getElementById("uploadPreview").src = uploadedImage;
          document.getElementById("uploadPreview").style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    }

    function addProduct() {
      const name = document.getElementById("product-name").value.trim();
      const price = document.getElementById("product-price").value.trim();
      const discount = document.getElementById("product-discount").value.trim();

      if (name && price && uploadedImage) {
        const products = JSON.parse(localStorage.getItem("products") || "[]");
        products.push({ name, price, discount, img: uploadedImage });
        localStorage.setItem("products", JSON.stringify(products));
        renderProducts(products);

        document.getElementById("product-name").value = "";
        document.getElementById("product-price").value = "";
        document.getElementById("product-discount").value = "";
        document.getElementById("newImgFile").value = "";
        document.getElementById("uploadPreview").style.display = "none";
        uploadedImage = "";
      } else {
        alert("Please enter name, price and upload an image.");
      }
    }

    function renderProducts(products) {
      const list = document.getElementById("product-list");
      list.innerHTML = "";
      products.forEach((p, index) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${p.img}" alt="${p.name}" style="width:100%;height:150px;object-fit:cover;border-radius:6px;"/>
          <h3>${p.name}</h3>
          <p class="price">${currentCurrency}${p.price}</p>
          <p class="discount">${p.discount || ""}</p>
          <button onclick="sendToWhatsApp('${p.name}')">Order via WhatsApp</button>
          ${loggedIn ? `<button class="delete" onclick="deleteProduct(${index})">Delete</button>` : ""}
        `;
        list.appendChild(card);
      });
    }

    function deleteProduct(index) {
      let products = JSON.parse(localStorage.getItem("products") || "[]");
      products.splice(index, 1);
      localStorage.setItem("products", JSON.stringify(products));
      renderProducts(products);
    }

    function sendToWhatsApp(productName) {
      const msg = encodeURIComponent(`Hello, I'm interested in ${productName}`);
      window.open(`https://wa.me/${whatsappNumber}?text=${msg}`, "_blank");
    }

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js")
          .then(reg => console.log("Service Worker registered:", reg))
          .catch(err => console.log("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
